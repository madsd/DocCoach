@using DocCoach.Web.Models.ViewModels

<MudPaper Class="@($"pa-4 {Class}")" Elevation="@Elevation">
    <MudStack Spacing="3">
        @if (!string.IsNullOrEmpty(Title))
        {
            <MudText Typo="Typo.h6">@Title</MudText>
        }
        
        @if (DataPoints != null && DataPoints.Count > 1)
        {
            <MudChart ChartType="ChartType.Line"
                      ChartSeries="@_series"
                      XAxisLabels="@_labels"
                      Width="100%"
                      Height="@Height"
                      ChartOptions="@_chartOptions" />
            
            @if (ShowSummary)
            {
                <MudStack Row="true" Justify="Justify.SpaceEvenly" Class="mt-2">
                    <MudStack AlignItems="AlignItems.Center" Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">First</MudText>
                        <MudText Typo="Typo.h6">@DataPoints.First().Score</MudText>
                    </MudStack>
                    
                    <MudStack AlignItems="AlignItems.Center" Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Current</MudText>
                        <MudText Typo="Typo.h6" Color="@GetTrendColor()">@DataPoints.Last().Score</MudText>
                    </MudStack>
                    
                    <MudStack AlignItems="AlignItems.Center" Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Change</MudText>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@GetTrendIcon()" 
                                     Size="Size.Small" 
                                     Color="@GetTrendColor()" />
                            <MudText Typo="Typo.h6" Color="@GetTrendColor()">
                                @GetTrendText()
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudStack>
            }
        }
        else if (DataPoints != null && DataPoints.Count == 1)
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                <MudText Typo="Typo.body2">
                    Only one review available. Review more versions of this document to see the score trend.
                </MudText>
            </MudAlert>
            
            <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center" Class="py-4">
                <MudText Typo="Typo.h3" Color="@GetScoreColor(DataPoints.First().Score)">
                    @DataPoints.First().Score
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="ml-2">
                    Current Score
                </MudText>
            </MudStack>
        }
        else
        {
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="text-center py-4">
                No score history available
            </MudText>
        }
    </MudStack>
</MudPaper>

@code {
    /// <summary>Chart title.</summary>
    [Parameter] public string? Title { get; set; }
    
    /// <summary>Score history data points.</summary>
    [Parameter] public List<ScoreHistoryPoint>? DataPoints { get; set; }
    
    /// <summary>Chart height.</summary>
    [Parameter] public string Height { get; set; } = "200px";
    
    /// <summary>Show summary stats below chart.</summary>
    [Parameter] public bool ShowSummary { get; set; } = true;
    
    /// <summary>Paper elevation.</summary>
    [Parameter] public int Elevation { get; set; } = 2;
    
    /// <summary>Additional CSS classes.</summary>
    [Parameter] public string? Class { get; set; }
    
    /// <summary>Click callback for data point (review navigation).</summary>
    [Parameter] public EventCallback<string> OnPointClick { get; set; }
    
    private List<ChartSeries> _series = new();
    private string[] _labels = Array.Empty<string>();
    private ChartOptions _chartOptions = new()
    {
        MaxNumYAxisTicks = 5,
        YAxisLines = true,
        YAxisTicks = 20,
        LineStrokeWidth = 3
    };
    
    protected override void OnParametersSet()
    {
        if (DataPoints != null && DataPoints.Count > 0)
        {
            _labels = DataPoints.Select(d => d.Label).ToArray();
            _series = new List<ChartSeries>
            {
                new ChartSeries
                {
                    Name = "Score",
                    Data = DataPoints.Select(d => (double)d.Score).ToArray()
                }
            };
        }
    }
    
    private int GetTotalChange()
    {
        if (DataPoints == null || DataPoints.Count < 2)
            return 0;
        
        return DataPoints.Last().Score - DataPoints.First().Score;
    }
    
    private Color GetTrendColor()
    {
        var change = GetTotalChange();
        return change > 0 ? Color.Success 
             : change < 0 ? Color.Error 
             : Color.Default;
    }
    
    private string GetTrendIcon()
    {
        var change = GetTotalChange();
        return change > 0 ? Icons.Material.Filled.TrendingUp 
             : change < 0 ? Icons.Material.Filled.TrendingDown 
             : Icons.Material.Filled.TrendingFlat;
    }
    
    private string GetTrendText()
    {
        var change = GetTotalChange();
        return change > 0 ? $"+{change}" : change.ToString();
    }
    
    private Color GetScoreColor(int score)
    {
        return score switch
        {
            >= 80 => Color.Success,
            >= 60 => Color.Warning,
            _ => Color.Error
        };
    }
}
